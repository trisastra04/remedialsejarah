<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Remedial Sejarah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standar */
        }
        .selected-answer {
            background-color: #4f46e5 !important;
            color: white !important;
            border-color: #4f46e5 !important;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <!-- Tombol Reset Aplikasi di Pojok Halaman -->
    <button id="reset-button" class="fixed top-4 left-4 text-xs text-slate-500 hover:text-red-600 hover:underline transition-colors z-50">
        Reset Aplikasi
    </button>

    <div id="app-container" class="bg-white w-full max-w-6xl rounded-2xl shadow-lg p-6 md:p-8 transition-all duration-300">

        <!-- Tampilan Login -->
        <div id="login-screen">
            <h1 class="text-3xl font-bold text-slate-800 text-center">Login Murid (Remedial)</h1>
            <p class="text-slate-600 text-center mt-4">Silakan pilih kelas dan masukkan kode akses untuk melanjutkan.</p>
            
            <div class="mt-8 space-y-4 max-w-md mx-auto">
                <div>
                    <label for="class-dropdown" class="block text-sm font-medium text-slate-700">Pilih Kelas</label>
                    <select id="class-dropdown" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3 bg-slate-50">
                        <option value="">Memuat kelas...</option>
                    </select>
                </div>
                <div>
                    <label for="access-code-input" class="block text-sm font-medium text-slate-700">Kode Akses</label>
                    <input type="password" id="access-code-input" placeholder="Masukkan kode akses" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3">
                </div>
                 <div id="name-container" class="hidden">
                    <label for="name-dropdown" class="block text-sm font-medium text-slate-700">Pilih Nama Anda</label>
                    <select id="name-dropdown" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3 bg-slate-50">
                        <option value="">Pilih Nama</option>
                    </select>
                </div>
            </div>

            <div class="max-w-md mx-auto">
                <button id="start-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-300 mt-8 text-lg disabled:bg-slate-400 disabled:cursor-not-allowed">
                    Gaskeun
                </button>
                <p id="attempt-error" class="text-red-600 text-center text-sm mt-2 h-4"></p>
            </div>
        </div>
        
        <!-- Pop Up Peraturan -->
        <div id="rules-modal" class="absolute inset-0 bg-white flex items-center justify-center hidden z-50 p-8 rounded-2xl">
            <div class="text-center max-w-2xl">
                <h2 class="text-3xl font-bold text-slate-800">Peraturan Remedial</h2>
                <div class="my-6 text-justify bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md">
                    <p class="font-bold text-lg text-center">Peringatan Penting:</p>
                    <p class="mt-2">Jika Anda beralih ke tab lain, membuka jendela/aplikasi lain, atau meninggalkan halaman ujian ini, Anda akan diberikan <strong>SATU KALI PERINGATAN</strong>. Pelanggaran kedua akan menghentikan ujian secara permanen.</p>
                    <p class="mt-2">Setiap murid hanya dapat mengerjakan ujian sebanyak <strong class="uppercase">MAKSIMAL 2 KALI</strong>.</p>
                </div>
                <p class="text-slate-600 text-justify">Pastikan Anda fokus mengerjakan ujian.</p>
                <button id="agree-button" class="w-full max-w-xs mx-auto mt-8 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-300 text-lg">
                    Saya Mengerti dan Setuju
                </button>
            </div>
        </div>

        <!-- Pop Up Peringatan Pindah Tab -->
        <div id="warning-modal" class="absolute inset-0 bg-red-600/90 backdrop-blur-sm flex items-center justify-center hidden z-50 p-8 rounded-2xl text-white">
            <div class="text-center max-w-2xl">
                <h2 class="text-5xl font-bold">PERINGATAN!</h2>
                <p class="mt-4 text-xl">Anda terdeteksi meninggalkan jendela ujian. Ujian telah dijeda.</p>
                <p class="mt-2 font-bold text-yellow-300 text-lg">Ini adalah peringatan pertama dan terakhir Anda. Jika Anda melakukannya lagi, ujian akan dihentikan secara permanen dan skor tidak akan disimpan.</p>
                <button id="resume-button" class="w-full max-w-xs mx-auto mt-8 bg-white text-red-600 font-bold py-3 px-6 rounded-lg hover:bg-slate-100 transition-colors duration-300 text-lg">
                    Saya Mengerti, Lanjutkan Ujian
                </button>
            </div>
        </div>

        <!-- Pop Up Reset -->
        <div id="reset-modal" class="absolute inset-0 bg-white flex items-center justify-center hidden z-50 p-8 rounded-2xl">
            <div class="text-center max-w-lg">
                <h2 class="text-3xl font-bold text-slate-800">Reset Aplikasi</h2>
                <p class="mt-4 text-slate-600">Apakah Anda yakin ingin mereset semua data percobaan ujian di browser ini?</p>
                <div class="mt-8 flex justify-center gap-4">
                     <button id="cancel-reset-button" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-300">Batal</button>
                    <button id="confirm-reset-button" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700">Ya, Reset Sekarang</button>
                </div>
            </div>
        </div>

        <!-- Pop Up Password Reset -->
        <div id="password-reset-modal" class="absolute inset-0 bg-white flex items-center justify-center hidden z-50 p-8 rounded-2xl">
            <div class="text-center max-w-lg">
                <h2 class="text-3xl font-bold text-slate-800">Autentikasi Admin</h2>
                <p class="mt-4 text-slate-600">Masukkan ID dan password admin untuk melanjutkan.</p>
                <div class="my-6 space-y-4">
                    <input type="text" id="id-reset-input" placeholder="ID Admin" class="mt-1 block w-full max-w-xs mx-auto rounded-md border-slate-300 shadow-sm p-3">
                    <input type="password" id="password-reset-input" placeholder="Password Admin" class="mt-1 block w-full max-w-xs mx-auto rounded-md border-slate-300 shadow-sm p-3">
                    <p id="password-reset-error" class="text-red-600 text-center text-sm mt-2 h-4"></p>
                </div>
                <div class="mt-8 flex justify-center gap-4">
                    <button id="cancel-password-reset-button" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-300">Batal</button>
                    <button id="confirm-password-reset-button" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700">Konfirmasi Reset</button>
                </div>
            </div>
        </div>

        <!-- Tampilan Loading Soal -->
        <div id="loading-screen" class="hidden text-center py-10">
            <p id="loading-text" class="text-slate-600">Memuat...</p>
        </div>

        <!-- Tampilan Kuis -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Soal Remedial</h2>
                    <div class="mt-2 text-sm text-slate-600 border-l-4 border-indigo-200 pl-3">
                        <p><span class="font-semibold">Nama:</span> <span id="student-name-display"></span></p>
                        <p><span class="font-semibold">Kelas:</span> <span id="student-class-display"></span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="timer-display" class="text-red-700 font-semibold bg-red-100 py-1 px-3 rounded-lg">--:--</span>
                    <span id="question-counter" class="text-slate-500 font-semibold bg-slate-100 py-1 px-3 rounded-lg"></span>
                </div>
            </div>
            <p id="question-text" class="text-lg text-slate-700 mb-6 min-h-[60px] whitespace-pre-wrap"></p>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div class="mt-8 flex justify-end">
                <button id="next-button" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors duration-300 disabled:bg-slate-300 disabled:cursor-not-allowed">
                    Selanjutnya
                </button>
            </div>
        </div>

        <!-- Tampilan Hasil -->
        <div id="result-screen" class="hidden text-center">
            <h1 class="text-3xl font-bold text-slate-800">Remedial Selesai!</h1>
            <p class="text-xl text-slate-600 mt-4">Skor Akhir Anda:</p>
            <p id="score-text" class="text-6xl font-bold text-indigo-600 my-4"></p>
            <p id="score-details" class="text-slate-600 mb-8"></p>
            
            <div id="submission-status-container" class="mt-6 border-t pt-6">
                 <div class="bg-slate-100 p-3 rounded-lg max-w-md mx-auto text-left mb-4">
                    <p class="text-sm text-slate-500">Nama Peserta:</p>
                    <p id="final-name" class="font-semibold text-slate-800"></p>
                    <p class="text-sm text-slate-500 mt-2">Kelas:</p>
                    <p id="final-class" class="font-semibold text-slate-800"></p>
                </div>
                <p id="submit-status" class="text-sm text-slate-500 mt-2 h-5"></p>
            </div>

            <div id="answer-review-section" class="mt-8 pt-6 border-t hidden">
                <h2 class="text-2xl font-bold text-slate-800 text-left mb-4">Pembahasan Jawaban Anda</h2>
                <div id="answer-review-container" class="space-y-4 text-left"></div>
            </div>
            
            <button id="retry-button" class="w-full max-w-xs mx-auto bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-300 text-lg mt-8 hidden">
                Kerjakan Lagi
            </button>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // --- PENGATURAN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDZCth3DrMVVdi0ONJgXv7DuoHJsf8-M5Q",
            authDomain: "aplikasi-ulangan-sejarah.firebaseapp.com",
            projectId: "aplikasi-ulangan-sejarah",
            storageBucket: "aplikasi-ulangan-sejarah.appspot.com",
            messagingSenderId: "571845428965",
            appId: "1:571845428965:web:a8c4e5da384fbf798fb60c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // --- AKHIR PENGATURAN FIREBASE ---

        // --- PENGATURAN UMUM ---
        const quizURLs = {
            'Kelas X': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=427248072&single=true&output=csv',
            'Kelas XI': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=0&single=true&output=csv',
            'Kelas XII': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=1252248885&single=true&output=csv',
        };
        const studentSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=463026985&single=true&output=csv';
        const accessCodeSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=361839719&single=true&output=csv';
        const adminPasswordSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=1382150609&single=true&output=csv';
        const webAppURL = 'https://script.google.com/macros/s/AKfycby6XV6ZMW2VjYo9ErEGiFM0hj78WIB2bktrRzeinZ8n1km4Dv9F_4C2luxNPzgZ3ZHS/exec';
        const remedialPlanURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=1004047688&single=true&output=csv';
        
        // --- ELEMEN DOM ---
        let allElements;

        // --- STATE APLIKASI ---
        let state = {
            fullQuizData: [], selectedQuizData: [], studentData: {}, accessCodeData: {}, adminCredentials: [], selectedClass: '', selectedName: '',
            currentQuestionIndex: 0, studentAnswers: {}, answeredQuestionsLog: [],
            timerInterval: null, timeLeft: 0, studentSessionId: null, isFinished: false, warningGiven: false, isPausedByCheating: false,
        };
        
        // --- FUNGSI-FUNGSI LENGKAP ---

        function parseCSV(csvText){const rows=[];let inQuotes=!1,currentField="",currentRow=[];csvText=csvText.trim();for(let i=0;i<csvText.length;i++){const char=csvText[i],nextChar=csvText[i+1];if(inQuotes)char==='"'&&nextChar==='"'?(currentField+='"',i++):char==='"'?inQuotes=!1:currentField+=char;else if(char==='"')inQuotes=!0;else if(char===",")currentRow.push(currentField.trim()),currentField="";else if(char==="\n"||char==="\r")currentRow.push(currentField.trim()),rows.push(currentRow),currentRow=[],currentField="",char==="\r"&&nextChar==="\n"&&i++;else currentField+=char}if(currentField||currentRow.length>0)currentRow.push(currentField.trim()),rows.push(currentRow);return rows}
        async function fetchStudentData(){try{const response=await fetch(studentSheetURL);if(!response.ok)throw new Error("Gagal memuat data siswa.");const csvText=await response.text(),rows=parseCSV(csvText),headers=rows.shift();return state.studentData={},headers&&(headers.forEach(header=>{state.studentData[header]=[]}),rows.forEach(row=>{row.forEach((name,index)=>{name&&headers[index]&&state.studentData[headers[index]].push(name)})})),headers}catch(error){return alert(`Gagal memuat data siswa: ${error.message}`),console.error("Kesalahan fetchStudentData:",error),null}}
        async function fetchAccessCodes(){try{const response=await fetch(accessCodeSheetURL);if(!response.ok)throw new Error("Gagal memuat data kode akses.");const csvText=await response.text(),rows=parseCSV(csvText),headers=rows[0],codeRow=rows[1];state.accessCodeData={},headers&&codeRow&&headers.forEach((className,index)=>{codeRow[index]&&(state.accessCodeData[className]=codeRow[index])})}catch(error){alert(`Gagal memuat kode akses: ${error.message}`),console.error(error)}}
        async function fetchAdminCredentials(){try{const response=await fetch(adminPasswordSheetURL);if(!response.ok)throw new Error("Gagal memuat kredensial admin.");const csvText=await response.text(),rows=parseCSV(csvText);rows.shift(),state.adminCredentials=rows.map(row=>({id:row[0],password:row[1]})).filter(cred=>cred.id&&cred.password)}catch(error){console.error(error),alert(`Gagal memuat kredensial admin: ${error.message}`)}}
        async function fetchRemedialPlan(className,studentName){allElements.loadingText.textContent="Mencari rencana remedial...";if(!remedialPlanURL||!remedialPlanURL.startsWith("https"))throw new Error("URL untuk Rencana Remedial belum diatur.");try{const response=await fetch(remedialPlanURL+"&t="+new Date().getTime());if(!response.ok)throw new Error("Gagal memuat rencana remedial.");const csvText=await response.text(),rows=parseCSV(csvText),headers=rows.shift(),colMap={kelas:headers.indexOf("Kelas"),nama:headers.indexOf("Nama"),nomorSoal:headers.indexOf("NomorSoal")};if(colMap.kelas===-1||colMap.nama===-1||colMap.nomorSoal===-1)throw new Error("Format kolom pada sheet Rencana Remedial salah.");const studentPlan=rows.find(row=>row[colMap.kelas]===className&&row[colMap.nama]===studentName);return studentPlan?studentPlan[colMap.nomorSoal].split(",").map(n=>parseInt(n.trim())).filter(num=>!isNaN(num)):[]}catch(error){return console.error(error),alert("Terjadi kesalahan saat memuat rencana remedial: "+error.message),null}}
        function populateClassDropdown(classes){allElements.classDropdown.innerHTML='<option value="">-- Pilih Kelas --</option>',classes&&classes.forEach(className=>{if(className){const option=document.createElement("option");option.value=className,option.textContent=className,allElements.classDropdown.appendChild(option)}})}
        function checkLoginConditions(){const code=allElements.accessCodeInput.value.trim(),className=allElements.classDropdown.value,correctCodeForClass=state.accessCodeData[className];className&&code&&code===correctCodeForClass?(allElements.nameContainer.classList.remove("hidden"),populateNameDropdown(className)):(allElements.nameContainer.classList.add("hidden"),allElements.nameDropdown.innerHTML=""),checkStartButton()}
        function populateNameDropdown(className){allElements.nameDropdown.innerHTML='<option value="">-- Pilih Nama --</option>',state.studentData[className]&&state.studentData[className].forEach(name=>{const option=document.createElement("option");option.value=name,option.textContent=name,allElements.nameDropdown.appendChild(option)})}
        function checkStartButton(){const className=allElements.classDropdown.value,name=allElements.nameDropdown.value,code=allElements.accessCodeInput.value.trim(),correctCodeForClass=state.accessCodeData[className];allElements.attemptError.textContent="",allElements.startButton.disabled=!0,className&&name&&code===correctCodeForClass&&parseInt(localStorage.getItem(`${className} - ${name}`)||"0")>=2?allElements.attemptError.textContent="Anda sudah mencapai batas maksimal pengerjaan (2 kali).":allElements.startButton.disabled=!1}
        async function fetchQuizData(quizSheetURL){allElements.loadingText.textContent="Memuat bank soal...";try{const response=await fetch(quizSheetURL);if(!response.ok)throw new Error("Gagal memuat soal dari Google Sheet.");const csvText=await response.text(),rows=parseCSV(csvText),headers=rows.shift(),colMap={soal:headers.indexOf("Soal"),opsiA:headers.indexOf("Opsi A"),opsiB:headers.indexOf("Opsi B"),opsiC:headers.indexOf("Opsi C"),opsiD:headers.indexOf("Opsi D"),opsiE:headers.indexOf("Opsi E"),kunci:headers.indexOf("Kunci Jawaban")};if(colMap.kunci===-1)throw new Error("Format kolom 'Kunci Jawaban' salah.");state.fullQuizData=[],rows.forEach((columns,index)=>{const question=columns[colMap.soal],options=[columns[colMap.opsiA],columns[colMap.opsiB],columns[colMap.opsiC],columns[colMap.opsiD],columns[colMap.opsiE]].filter(opt=>opt&&opt.trim()!==""),key=columns[colMap.kunci]?.toUpperCase().trim();let answer="";key==="A"?answer=columns[colMap.opsiA]:key==="B"?answer=columns[colMap.opsiB]:key==="C"?answer=columns[colMap.opsiC]:key==="D"?answer=columns[colMap.opsiD]:key==="E"&&(answer=columns[colMap.opsiE]),question&&options.length>1&&answer&&state.fullQuizData.push({question,options,answer,originalIndex:index+1})});if(state.fullQuizData.length===0)throw new Error("Tidak ada soal yang berhasil dimuat.");return!0}catch(error){return alert(`Terjadi Kesalahan: ${error.message}`),!1}}
        async function startQuiz(){state.selectedClass=allElements.classDropdown.value,state.selectedName=allElements.nameDropdown.value,state.studentSessionId=`${state.selectedClass} - ${state.selectedName}`,allElements.loginScreen.classList.add("hidden"),allElements.loadingScreen.classList.remove("hidden");const remedialQuestionNumbers=await fetchRemedialPlan(state.selectedClass,state.selectedName);if(remedialQuestionNumbers===null){allElements.loadingScreen.classList.add("hidden"),allElements.loginScreen.classList.remove("hidden");return}if(remedialQuestionNumbers.length===0){allElements.loadingScreen.classList.add("hidden"),alert("Tidak ada soal remedial yang ditugaskan untuk Anda."),resetToLogin();return}let quizSheetURL="";state.selectedClass.startsWith("Kelas XII")?quizSheetURL=quizURLs["Kelas XII"]:state.selectedClass.startsWith("Kelas XI")?quizSheetURL=quizURLs["Kelas XI"]:state.selectedClass.startsWith("Kelas X")&&(quizSheetURL=quizURLs["Kelas X"]);if(!quizSheetURL.startsWith("https")){alert(`URL bank soal untuk ${state.selectedClass} belum diatur.`);return}const success=await fetchQuizData(quizSheetURL);allElements.loadingScreen.classList.add("hidden"),success?(state.selectedQuizData=state.fullQuizData.filter(q=>remedialQuestionNumbers.includes(q.originalIndex)),allElements.studentNameDisplay.textContent=state.selectedName,allElements.studentClassDisplay.textContent=state.selectedClass,allElements.rulesModal.classList.remove("hidden")):allElements.loginScreen.classList.remove("hidden")}
        function pauseTimer(){clearInterval(state.timerInterval)}function resumeTimer(){state.timerInterval=setInterval(()=>{state.timeLeft--,updateTimerDisplay(),state.timeLeft<=0&&(clearInterval(state.timerInterval),showResults(!1))},1e3)}function startTimer(){state.timeLeft=state.selectedQuizData.length*90,updateTimerDisplay(),resumeTimer()}
        function updateTimerDisplay(){const minutes=Math.floor(state.timeLeft/60),seconds=state.timeLeft%60;allElements.timerDisplay.textContent=`${String(minutes).padStart(2,"0")}:${String(seconds).padStart(2,"0")}`,state.timeLeft<=60&&state.timeLeft>0?allElements.timerDisplay.classList.add("animate-pulse"):allElements.timerDisplay.classList.remove("animate-pulse")}
        function updateStudentStatus(statusUpdate){state.studentSessionId&&db.collection("remedial_sessions").doc(state.studentSessionId).update(statusUpdate).catch(error=>console.error("Gagal update status: ",error))}
        function logCheatingEvent(){state.studentSessionId&&db.collection("cheating_log").add({nama:state.selectedName,kelas:state.selectedClass,timestamp:firebase.firestore.FieldValue.serverTimestamp(),type:"Remedial"}).catch(error=>console.error("Gagal mencatat riwayat: ",error))}
        function handleCheatingDetection(){!allElements.quizScreen.classList.contains("hidden")&&!state.isPausedByCheating&&(state.warningGiven?(logCheatingEvent(),showResults(!0)):(pauseTimer(),state.isPausedByCheating=!0,state.warningGiven=!0,updateStudentStatus({status:"Peringatan 1: Keluar Jendela"}),allElements.warningModal.classList.remove("hidden")))}
        const handleVisibilityChange=()=>{document.hidden&&handleCheatingDetection()};
        async function proceedToExam(){const studentId=state.studentSessionId,attempts=parseInt(localStorage.getItem(studentId)||"0");localStorage.setItem(studentId,attempts+1),state.selectedQuizData.sort(()=>Math.random()-.5),state.currentQuestionIndex=0,state.studentAnswers={},state.isFinished=!1,state.warningGiven=!1;try{await db.collection("remedial_sessions").doc(state.studentSessionId).set({nama:state.selectedName,kelas:state.selectedClass,soalDikerjakan:0,totalSoal:state.selectedQuizData.length,status:"Mengerjakan",last_updated:firebase.firestore.FieldValue.serverTimestamp()})}catch(error){console.error("Gagal mengirim status awal ke Firebase:",error),alert("Gagal terhubung ke server monitoring. Ujian akan tetap dilanjutkan tanpa pemantauan real-time.")}allElements.quizScreen.classList.remove("hidden"),loadQuestion(),startTimer(),document.addEventListener("visibilitychange",handleVisibilityChange),window.addEventListener("blur",handleCheatingDetection)}
        function loadQuestion(){allElements.optionsContainer.innerHTML="";const currentQuestion=state.selectedQuizData[state.currentQuestionIndex];if(!currentQuestion)return console.error(`KESALAHAN: Tidak ada data soal pada indeks ${state.currentQuestionIndex}.`,state.selectedQuizData),alert("Terjadi kesalahan: Gagal memuat data soal berikutnya. Ujian dihentikan."),void showResults(!0);allElements.questionCounter.textContent=`Soal ${state.currentQuestionIndex+1} dari ${state.selectedQuizData.length}`,allElements.questionText.textContent=currentQuestion.question;const shuffledOptions=[...currentQuestion.options].sort(()=>Math.random()-.5);shuffledOptions.forEach(option=>{const button=document.createElement("button");button.textContent=option,button.classList.add("w-full","p-4","border-2","border-slate-300","rounded-lg","text-left","hover:bg-indigo-100","hover:border-indigo-400","transition-colors","duration-200"),state.studentAnswers[state.currentQuestionIndex]===option&&button.classList.add("selected-answer"),button.addEventListener("click",()=>selectAnswer(option,button)),allElements.optionsContainer.appendChild(button)}),updateNavButtons()}
        function updateNavButtons(){allElements.nextButton.textContent=state.currentQuestionIndex===state.selectedQuizData.length-1?"Selesai":"Selanjutnya"}
        function selectAnswer(option,buttonElement){state.studentAnswers[state.currentQuestionIndex]=option,document.querySelectorAll("#options-container button").forEach(btn=>btn.classList.remove("selected-answer")),buttonElement.classList.add("selected-answer")}
        function resetToLogin(){state.timerInterval&&clearInterval(state.timerInterval),document.removeEventListener("visibilitychange",handleVisibilityChange),window.removeEventListener("blur",handleCheatingDetection),state.studentSessionId&&db.collection("remedial_sessions").doc(state.studentSessionId).delete(),allElements.quizScreen.classList.add("hidden"),allElements.resultScreen.classList.add("hidden"),allElements.loginScreen.classList.remove("hidden"),allElements.accessCodeInput.value="",allElements.nameContainer.classList.add("hidden"),allElements.nameDropdown.innerHTML="",allElements.classDropdown.selectedIndex=0,checkStartButton()}
        function showResults(forceEnd=!1){if(state.isFinished)return;state.isFinished=!0,state.timerInterval&&clearInterval(state.timerInterval),document.removeEventListener("visibilitychange",handleVisibilityChange),window.removeEventListener("blur",handleCheatingDetection),state.studentSessionId&&db.collection("remedial_sessions").doc(state.studentSessionId).delete(),allElements.quizScreen.classList.add("hidden"),allElements.resultScreen.classList.remove("hidden");const resultTitle=allElements.resultScreen.querySelector("h1");if(forceEnd)resultTitle.textContent="Ulangan Dihentikan!",resultTitle.classList.add("text-red-600"),allElements.scoreDetails.textContent="Anda meninggalkan jendela ujian. Skor tidak disimpan.",allElements.submissionStatusContainer.classList.add("hidden"),allElements.retryButton.classList.remove("hidden");else{resultTitle.textContent="Remedial Selesai!",resultTitle.classList.remove("text-red-600");let score=0;state.answeredQuestionsLog=[];for(let i=0;i<state.selectedQuizData.length;i++){const question=state.selectedQuizData[i],studentAnswer=state.studentAnswers[i],isCorrect=studentAnswer===question.answer;state.answeredQuestionsLog.push({questionNumber:question.originalIndex,answer:studentAnswer||"Tidak Dijawab",correct:isCorrect}),isCorrect&&score++}const finalScore=state.selectedQuizData.length>0?Math.round(100/state.selectedQuizData.length*score):0;allElements.scoreText.textContent=finalScore,allElements.scoreDetails.textContent=`Anda berhasil menjawab benar ${score} dari ${state.selectedQuizData.length} soal.`,allElements.finalName.textContent=state.selectedName,allElements.finalClass.textContent=state.selectedClass,submitScore(score)}}
        function handleNav(){state.currentQuestionIndex<state.selectedQuizData.length-1?state.currentQuestionIndex++:showResults(!1),loadQuestion()}
        async function submitScore(score){allElements.submitStatus.textContent="Menyimpan skor secara otomatis...";const sortedLog=[...state.answeredQuestionsLog].sort((a,b)=>a.questionNumber-b.questionNumber),formattedLog=sortedLog.map(log=>`Soal ${log.questionNumber}: "${log.answer}" (${log.correct?"Benar":"Salah"})`).join("; "),finalScore=state.selectedQuizData.length>0?Math.round(100/state.selectedQuizData.length*score):0,data={nama:state.selectedName,kelas:state.selectedClass,jawabanBenar:score,totalSoal:state.selectedQuizData.length,nomorSoalDikerjakan:formattedLog,skor:finalScore,type:"Remedial"};try{const response=await fetch(webAppURL,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(data),redirect:"follow"});allElements.submitStatus.textContent="Skor berhasil disimpan!",allElements.submitStatus.style.color="green",displayAnswerReview(),allElements.retryButton.classList.remove("hidden")}catch(error){allElements.submitStatus.textContent="Gagal mengirim. Silakan periksa koneksi dan coba lagi.",allElements.submitStatus.style.color="red",allElements.retryButton.classList.remove("hidden")}}
        function displayAnswerReview(){allElements.answerReviewSection.classList.remove("hidden"),allElements.answerReviewContainer.innerHTML="";const sortedLog=[...state.answeredQuestionsLog].sort((a,b)=>a.questionNumber-b.questionNumber);sortedLog.forEach(log=>{const questionData=state.fullQuizData.find(q=>q.originalIndex===log.questionNumber);if(!questionData)return;const isCorrect=log.correct,resultClass=isCorrect?"border-green-500 bg-green-50":"border-red-500 bg-red-50";let answerHtml="";answerHtml=isCorrect?`<p class="mt-2 text-sm">Jawaban Anda: <span class="font-semibold text-green-700">${log.answer} (Benar)</span></p>`:`<p class="mt-2 text-sm">Jawaban Anda: <span class="font-semibold text-red-700">${log.answer} (Salah)</span></p>`;const questionElement=`\n            <div class="p-4 border-l-4 ${resultClass} rounded-r-lg">\n                <p class="font-semibold text-slate-800">Soal #${log.questionNumber}: ${questionData.question}</p>\n                ${answerHtml}\n            </div>\n        `;allElements.answerReviewContainer.innerHTML+=questionElement})}
        function showResetModal(){allElements.resetModal.classList.remove("hidden")}function hideResetModal(){allElements.resetModal.classList.add("hidden")}
        function requestResetPassword(){hideResetModal(),allElements.passwordResetModal.classList.remove("hidden")}
        function hidePasswordResetModal(){allElements.passwordResetModal.classList.add("hidden"),allElements.passwordResetInput.value="",allElements.idResetInput.value="",allElements.passwordResetError.textContent=""}
        function verifyAndReset(){const enteredId=allElements.idResetInput.value,enteredPassword=allElements.passwordResetInput.value,isValid=state.adminCredentials.find(cred=>cred.id===enteredId&&cred.password===enteredPassword);isValid?(localStorage.clear(),hidePasswordResetModal(),location.reload()):allElements.passwordResetError.textContent="ID atau Password salah."}
        
        document.addEventListener("DOMContentLoaded",async()=>{
            allElements = {
                loginScreen: document.getElementById('login-screen'), classDropdown: document.getElementById('class-dropdown'),
                accessCodeInput: document.getElementById('access-code-input'), nameContainer: document.getElementById('name-container'),
                nameDropdown: document.getElementById('name-dropdown'), loadingScreen: document.getElementById('loading-screen'),
                loadingText: document.getElementById('loading-text'),
                quizScreen: document.getElementById('quiz-screen'), resultScreen: document.getElementById('result-screen'),
                startButton: document.getElementById('start-button'), 
                prevButton: document.getElementById('prev-button'),
                nextButton: document.getElementById('next-button'),
                retryButton: document.getElementById('retry-button'), questionCounter: document.getElementById('question-counter'),
                questionText: document.getElementById('question-text'), optionsContainer: document.getElementById('options-container'),
                timerDisplay: document.getElementById('timer-display'), scoreText: document.getElementById('score-text'),
                scoreDetails: document.getElementById('score-details'), finalName: document.getElementById('final-name'),
                finalClass: document.getElementById('final-class'), 
                submitStatus: document.getElementById('submit-status'), 
                submissionStatusContainer: document.getElementById('submission-status-container'),
                studentNameDisplay: document.getElementById('student-name-display'), studentClassDisplay: document.getElementById('student-class-display'),
                rulesModal: document.getElementById('rules-modal'), agreeButton: document.getElementById('agree-button'),
                warningModal: document.getElementById('warning-modal'), resumeButton: document.getElementById('resume-button'),
                resetButton: document.getElementById('reset-button'), attemptError: document.getElementById('attempt-error'),
                resetModal: document.getElementById('reset-modal'), cancelResetButton: document.getElementById('cancel-reset-button'),
                confirmResetButton: document.getElementById('confirm-reset-button'),
                passwordResetModal: document.getElementById('password-reset-modal'),
                idResetInput: document.getElementById('id-reset-input'),
                passwordResetInput: document.getElementById('password-reset-input'),
                passwordResetError: document.getElementById('password-reset-error'),
                confirmPasswordResetButton: document.getElementById('confirm-password-reset-button'),
                cancelPasswordResetButton: document.getElementById('cancel-password-reset-button'),
                answerReviewSection: document.getElementById('answer-review-section'),
                answerReviewContainer: document.getElementById('answer-review-container'),
            };

            allElements.startButton.disabled=!0;
            await fetchAccessCodes();
            const classes = await fetchStudentData();
            await fetchAdminCredentials();
            populateClassDropdown(classes);

            allElements.classDropdown.addEventListener("change",checkLoginConditions);
            allElements.accessCodeInput.addEventListener("input",checkLoginConditions);
            allElements.nameDropdown.addEventListener("change",checkStartButton);
            allElements.startButton.addEventListener("click",startQuiz);
            allElements.nextButton.addEventListener("click",handleNav);
            allElements.retryButton.addEventListener("click",resetToLogin);
            allElements.agreeButton.addEventListener("click",()=>{allElements.rulesModal.classList.add("hidden"),proceedToExam()});
            allElements.resumeButton.addEventListener('click',()=>{allElements.warningModal.classList.add("hidden"),state.isPausedByCheating=!1,updateStudentStatus({status:"Mengerjakan"}),resumeTimer()});
            allElements.resetButton.addEventListener("click",showResetModal);
            allElements.cancelResetButton.addEventListener("click",hideResetModal);
            allElements.confirmResetButton.addEventListener("click",requestResetPassword);
            allElements.cancelPasswordResetButton.addEventListener("click",hidePasswordResetModal);
            allElements.confirmPasswordResetButton.addEventListener("click",verifyAndReset);
        });
    </script>
</body>
</html>

